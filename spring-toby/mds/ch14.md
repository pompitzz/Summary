# 2-5장 AOP와 LTW

## Aspect AOP
- 애스펙트는 독립적인 AOP 모듈을 뜻하는 개념이다.
    - 독립적인 포인트컷과 어드바이스 빈의 조합으로 만들어지는 어드바이저와 다르게 애스펙트는 다양한 조합을 갖는 포인트 컷과 어드바이스를 하나의 모듈에 정의할 수 있다.
- @AspectJ 애노테이션을 활용하여 애스펙트를 만들 수 있는데 해당 애노테이션을 사용하더라도 AspectJ AOP로 만드는게 아닌 일반 프록시 기반 AOP를 만들 수 있다.

### 자동 프록시 생성기와 프록시 빈
- 만약 AOP를 적용하여 해당 Target에 대한 프록시를 생성하여 빈으로 등록해준다면, 의존하는 객체 입장에서는 기존 타겟 빈과 프록시 빈이 존재하여 DI가 불가능해질 것이다.
- 그렇기 때문에 스프링은 빈 후처리기를 통해 기존 타겟빈들을 프록시 빈으로 바꿔치는 작업을 수행하여 실제 프록시 빈이 DI될 수 있도록 한다.
    - 실제로 타겟 빈은 외부로 노출되지 않고 프록시 빈에 감싸져 있기 때문에 정상적으로 DI가 가능해진다.
     

### 프록시의 종류
- 보통 자바의 기본 동적 프록시는 인터페이스를 구현한 프록시이므로 인터페이스만 동적 프록시를 적용할 수 있다.
- CGLib를 활용하면 바이트 코드를 조작해 해당 클래스를 상속받아 서브 클래스를 만들어 프록시를 만들어주도록 할 수 있다.
    - 기본적으로는 일반 자바 동적 프록시 기법으로 프록시를 만들어주지만 CGLib를 활용하는 경우가 있다.
    - 인터페이스로 구현되지 않은 타깃 클래스에 AOP를 적용하거나, 인터페이스를 구현하더라도 proxy-target-class를 true로 설정하면 CGLib를 활용하여 AOP를 만들도록할 수 있다.


### @Aspect 애노테이션으로 애스펙트를 생성하는 방법
- @PointCut을 붙인 메서드를 정의하여 포인트컷을 지정할 수 있다.
    - @Pointcut은 void 리턴 타입 메서드로 정의하여야 한다.
    - 조인 포인트는 어드바이스로 정의된 부가기능을 적용할 수 있는 위치로 프록시 기반 AOP의 경우 메서드만 가능하기 떄문에 보통 스프링에선 메서드만이 포인트컷이 될 수 있다.
    
    
- 어드바이스로 지정할 수 있는 애노테이션은 다음과 같다.
    - @Before
        - 타깃 오브젝트 메서드가 실행되기 전에 사용되는 어드바이스이다.
        - 해당 어드바이스로는 타깃 오브젝트 메서드를 호출하는 방식을 제어할 순 없고 보통 메서드가 호출되는 정보들을 참고하기 위해 사용된다.
        - proceed() 메서드가 존재하지 않는 ProceedingJoinPoint의 슈퍼 클래스인 JoinPoint를 활용한다.
    - @AfterReturing
        - 타깃 오브젝트 메서드가 실행을 마친뒤에 실행되는 어드바이스이다.
        - 예외가 발생하지 않는 경우에만 적용될 수 있다.
        - 메서드 종료시에 사용되는 어드바이스 이므로 메서드의 반환 값을 참조할 수 있어 반환 타입에 대한 정보를 얻기 위해 사용된다.
    - @AfterThrowing
        - 타깃 오브젝트의 메서드에서 예외가 발생하면 실행되는 어드바이스이다.
        - 예외를 전달받고자 하는 예외를 파라미터로 참조할 수 있다.
        - 모든 예외를 받고자 한다면 Throwable로 정의하면 될 것이다.
    - @After
        - 메서드 실행이 정상적으로 종료되었건, 예외가 발생했건간에 모두 실행될 수 있는 어드바이스이다.
        - finally 블럭과 비슷한 용도로 사용할 수 있지만 리턴 값이나 예외를 직접 전달받을 순 없다.
    - @Around
        - 프록시를 통해 타깃 오브젝트 메서드가 호출되는 전 과정을 처리할 수 있는 어드바이스이다.
